<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.or.ssff.mapper.StudyInsMapper">
    <delete id="remove">

        update SI_BOARD
        set REMOVED_OK='y'
        where CONT_NO = #{cont_No}

    </delete>

    <delete id="delete">

        delete
        from study_ins_file
        where cont_No = #{cont_No}

    </delete>

    <delete id="deleteFiles" parameterType="kr.or.ssff.studyIns.model.StudyInsFileDTO">
        delete
        from STUDY_INS_FILE
        where CONT_NO = #{cont_No}
    </delete>
    <insert id="insertBoard">
        insert into SI_BOARD(cont_No, member_name, r_idx, cont, category, title, REMOVED_OK, WRITE_DATE)
        values (#{cont_No}, #{member_Name}, #{r_Idx}, #{cont}, #{category}, #{title}, 'n', sysdate)


    </insert>


    <insert id="insertFiles" parameterType="java.util.List">
        insert into STUDY_INS_FILE(FILENO, CONT_NO,filename, uploadpath, uuid) select STUDY_INS_FILE_SQE.nextval, A.*from(
        <foreach collection="list" item="item" separator="UNION ALL ">
            select #{item.cont_No} as CONT_NO, #{item.file_Name} as FILE_NAME , #{item.uploadPath} as UPLOADPATH, #{item.uuid} as UUID from dual

        </foreach>) A
    </insert>




    <!-- 검색 조건 sql -->
    <select id="findMaxContNo" resultType="integer">
        select MAX(nvl2(CONT_NO, CONT_NO, 0))
        from SI_BOARD

    </select>

    <!-- 페이징 sql -->
    <select id="read" resultType="kr.or.ssff.studyIns.domain.StudyInsVO">

		<![CDATA[
        select CONT_NO,
               MEMBER_NAME,
               R_IDX,
               WRITE_DATE,
               MODIFY_DATE,
               REMOVED_OK,
               CONT,
               CATEGORY,
               TITLE,
               HIT
        from si_board
        where cont_No = #{cont_No}
          and REMOVED_OK = 'n'
        ]]>

	</select>
    <select id="getFileList" resultType="kr.or.ssff.studyIns.domain.StudyInsFileVO">
        select CONT_NO, FILENO, FILENAME, UPLOADPATH, UUID
        from STUDY_INS_FILE
        where CONT_NO = #{cont_No}
    </select>


    <select id="countArticle" resultType="integer">
        select count(*)
        from SI_BOARD
        where REMOVED_OK = 'n';

    </select>

    <!-- 게시글 전체 목록 조회 및 검색조회까지 -->
    <select id="getList" resultType="kr.or.ssff.studyIns.domain.StudyInsVO">
        <!-- 목록 조회 및 페이징 전체 쿼리 -->
        <include refid="pagingHeader"/><![CDATA[
        SELECT rownum, CONT_NO, MEMBER_NAME as member_Name, R_IDX, WRITE_DATE, MODIFY_DATE, REMOVED_OK, CONT, CATEGORY, TITLE, HIT
        FROM SI_BOARD b
        ]]><include refid="search"/><![CDATA[
        ORDER BY CONT_NO DESC, b.WRITE_DATE DESC
        ]]>
        <include refid="pagingFooter"/>
    </select>


    <sql id="search">
        <choose>
            <!-- 검색옵션이 전체 검색일 경우 -->

            <when test="searchOption == '전체'"><![CDATA[
                WHERE
                (b.member_Name like '%'||#{keyword}||'%'
                OR cont like '%'||#{keyword}||'%'
                OR title like '%'||#{keyword}||'%')
            ]]>
            </when>
            <!-- 전체 검색이 아닐 경우 -->
            <otherwise><![CDATA[
                WHERE ${searchOption} like '%'||#{keyword}||'%'
            ]]></otherwise>
        </choose>
    </sql>

    <sql id="pagingHeader"><![CDATA[
        SELECT *
        FROM (
                 SELECT ROWNUM AS rn, A.*
                 FROM (
        ]]></sql>

    <sql id="pagingFooter"><![CDATA[
        ) A
    ) WHERE rn BETWEEN
        #{start}
        AND
        #{end}
        ]]></sql>

    <update id="update">
        update si_board
        set title=#{title},
            cont=#{cont},
            modify_Date=sysdate,
            category=#{category}
        where cont_No = #{cont_No}
    </update>
</mapper>